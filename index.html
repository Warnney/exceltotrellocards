<!DOCTYPE html>
<html>
<head>
  <title>Excel to Trello Cards</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .container {
      margin: 20px;
    }
    .file-input {
      margin-bottom: 10px;
    }
    .button {
      padding: 10px 20px;
      background-color: #0079bf;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .select {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Excel to Trello Cards</h1>
    <select id="listSelect" class="select">
      <option value="" disabled selected>Selecione uma lista</option>
    </select>
    <input type="file" id="fileInput" class="file-input" />
    <button id="uploadButton" class="button">Upload Excel</button>
    <div id="status"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://trello.com/1/client.js?key=07ba9bd8332fef8cfcd1ee8bab1bfb3b"></script>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    window.TrelloPowerUp.initialize({
      'board-buttons': function(t, options) {
        return [{
          icon: 'https://example.com/icon.png',
          text: 'Upload Excel',
          callback: function(t) {
            return t.popup({
              title: 'Upload Excel',
              url: 'https://warnney.github.io/exceltotrellocards/'
            });
          }
        }];
      },
      'authorization-status': function(t) {
        return t.get('member', 'private', 'token').then(function(token) {
          return { authorized: token !== null }
        });
      },
      'show-settings': function(t) {
        return t.popup({
          title: 'Settings',
          url: 'https://warnney.github.io/exceltotrellocards/settings.html',
          height: 184
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Verifica se está autorizado e chama a função de carregamento das listas
      Trello.authorize({
        type: 'popup',
        name: 'Excel to Trello Cards',
        scope: {
          read: 'true',
          write: 'true'
        },
        expiration: 'never',
        success: function() {
          Trello.members.get("me", function(member) {
            var boardId = window.location.hash.split('/')[1];
            loadTrelloLists(boardId);
          });
        },
        error: function() {
          document.getElementById('status').innerText = 'Erro na autenticação com o Trello.';
        }
      });

      function loadTrelloLists(boardId) {
        Trello.get(`/boards/${boardId}/lists`, function(lists) {
          const listSelect = document.getElementById('listSelect');
          lists.forEach(function(list) {
            const option = document.createElement('option');
            option.value = list.id;
            option.text = list.name;
            listSelect.appendChild(option);
          });
        });
      }

      document.getElementById('uploadButton').addEventListener('click', function() {
        const listId = document.getElementById('listSelect').value;
        if (!listId) {
          alert('Por favor, selecione uma lista.');
          return;
        }

        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) {
          alert('Por favor, selecione um arquivo Excel.');
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet);
          createTrelloCards(json, listId);
        };
        reader.readAsArrayBuffer(file);
      });

      function createTrelloCards(data, listId) {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = 'Criando cards...';

        data.forEach(item => {
          const title = item['Título'];
          const dueDate = item['Data de Entrega'];
          const description = item['Descrição'];

          Trello.post(`/cards`, {
            name: title,
            desc: description,
            idList: listId,
            due: dueDate
          }, function(card) {
            console.log(`Card "${title}" criado com sucesso!`);
          }, function(error) {
            console.error(`Erro ao criar o card "${title}":`, error);
          });
        });

        statusDiv.innerHTML = 'Cards criados com sucesso!';
      }
    });
  </script>
</body>
</html>
